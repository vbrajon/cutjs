<meta charset="utf-8" />
<link rel="icon" href="data:," />
<!-- prettier-ignore -->
<style>
  * { outline: inherit;font: inherit; }
  body { margin: 80px;caret-color: orange;color: white;background: #0d1116;font-family: sans-serif;font-size: 14px;line-height: 20px; }
  .editor { position: relative;overflow: hidden;width: 100%;font-family: ui-monospace,SFMono-Regular,SF Mono,Menlo,Consolas,Liberation Mono,monospace; }
  .editor textarea { position: absolute;inset: 0;padding: 20px;overflow: hidden;color: transparent;background: transparent;border: none;outline: none;resize: none; }
  .editor pre { min-height: 100px;pointer-events: none;margin: 0;padding: 20px;background: #161b22!important;white-space: pre-wrap; }
</style>
<div class="editor">
  <textarea autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></textarea>
  <pre></pre>
</div>
<script type="module">
  import { codeToHtml } from "https://esm.sh/shiki@1.0.0"
  import cut from "./cut.js"
  cut("mode", "prototype")
  window.cut = cut
  const textarea = document.querySelector("textarea")
  const max = (textarea.clientWidth - 40) / 8.5
  textarea.addEventListener("input", refresh)
  const code = `const users = [
  { name: "John", age: 25, city: "Paris" },
  { name: "Jane", age: 30, city: "London" },
  { name: "Jack", age: 20, city: "New York" },
]
users.map("name")
users.sum("age")
users
  .group("city")
  .map("[0].name")
  .entries()
  .sum(v => 1)
  .duration()
  .format("snake")
  .is(String)`
  textarea.value = code
  refresh()
  async function refresh() {
    let error
    try {
      eval(textarea.value)
    } catch (e) {
      error = e.message
    }
    if (error) document.querySelector(".editor").style = "border: 1px solid red;"
    else document.querySelector(".editor").style = "border: 1px solid transparent;"
    function comment(line, i) {
      if (!line) return
      // if (!/\.(map|reduce|filter|find|findIndex|sum|min|max|avg)/.test(line)) return line
      try {
        const result = eval(lines.slice(0, i + 1).join("\n"))
        if (result === undefined) return line
        const str = result instanceof Function ? result.toString() : JSON.stringify(result)
        const com = line + " // " + str
        const brk = com.indexOf("\n") === -1 ? max : Math.min(max, com.indexOf("\n"))
        // console.log(com, brk)
        if (com.length > brk) return com.slice(0, brk) + "â€¦"
        return com
      } catch (e) {
        if (e.message === error) {
          error = null
          return line + " //! " + e.message
        }
        return line
      }
    }
    const lines = textarea.value.split("\n")
    const comments = lines.map((line, i) => comment(line, i))
    const code = comments.join("\n") + "\n"
    document.querySelector("pre").outerHTML = await codeToHtml(code, { lang: "js", theme: "github-dark" })
  }
</script>
