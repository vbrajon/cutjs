<meta charset="utf-8" />
<link rel="icon" href="data:," />
<!-- prettier-ignore -->
<style>
  * { outline: inherit;font: inherit; }
  body { margin: 80px;caret-color: orange;color: white;background: #0d1116;font-family: sans-serif;font-size: 14px;line-height: 20px; }
  .editor { position: relative;overflow: hidden;width: 100%;font-family: ui-monospace,SFMono-Regular,SF Mono,Menlo,Consolas,Liberation Mono,monospace; }
  .editor textarea { position: absolute;inset: 0;padding: 20px;overflow: hidden;color: transparent;background: transparent;border: none;outline: none;resize: none; }
  .editor pre { min-height: 100px;pointer-events: none;margin: 0;padding: 20px;background: #161b22!important;white-space: pre-wrap; }
</style>
<div class="editor">
  <textarea autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></textarea>
  <pre></pre>
</div>
<script type="module">
  import { codeToHtml } from "https://esm.sh/shiki@1.0.0"
  import cut from "./cut.js"
  cut("mode", "prototype")
  window.cut = cut
  const textarea = document.querySelector("textarea")
  const max = (textarea.clientWidth - 40) / 9
  textarea.addEventListener("input", refresh)
  const code = `const users = [
  { name: "John", age: 25, city: "Paris" },
  { name: "Jane", age: 30, city: "London" },
  { name: "Jack", age: 20, city: "New York" },
]
users.map("name")
users.sum("age")
users
  .group("city")
  .map("[0].name")
  .entries()
  .sum(v => 1)
  .duration()
  .format("snake")
  .is(String)`
  textarea.value = code
  refresh()
  async function run(code) {
    try {
      const lines = code.split("\n")
      const wordLineIndex = lines
        .slice()
        .reverse()
        .findIndex((l) => /^\s*[a-z]/.test(l))
      const index = wordLineIndex === -1 ? 0 : lines.length - wordLineIndex - 1
      lines[index] = "return " + lines[index]
      code = lines.join("\n")
      return { data: await eval(`(async () => {${code}})()`) }
    } catch (error) {
      return { error }
    }
  }
  async function comment(line, i, all) {
    const lines = all.slice(0, i + 1)
    if (!line) return line
    const { data, error } = await run(lines.join("\n"))
    if (error) {
      if (!all.message) all.message = (await run(all.join("\n"))).error?.message ?? "none"
      if (all.skip || all.message !== error.message) return line
      all.skip = true
      return line + " //!\\\\ " + error.message
    }
    const str = data instanceof Function ? data.toString() : JSON.stringify(data)
    const com = line + " // " + str
    const brk = com.indexOf("\n") === -1 ? max : Math.min(max, com.indexOf("\n"))
    // console.log(com, brk)
    if (com.length > brk) return com.slice(0, brk) + "â€¦"
    return com
  }
  async function comments(code) {
    const lines = code.split("\n")
    const linesWithComments = await Promise.all(lines.map(comment))
    return linesWithComments.join("\n") + "\n"
  }
  async function refresh() {
    const code = await comments(textarea.value)
    document.querySelector("pre").outerHTML = await codeToHtml(code, { lang: "js", theme: "github-dark" })
    document.querySelector(".editor").style = "border: 1px solid transparent;"
    if (!code.includes(`//!\\`)) return
    document.querySelector(".editor").style = "border: 1px solid red;"
    $$('[style="color:#6A737D"]').at(-1).style = "color:red"
  }
  function $$(selector, root = document) {
    return [...root.querySelectorAll(selector)]
  }
</script>
