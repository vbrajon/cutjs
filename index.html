<title>CutJS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="icon" type="image/svg+xml" sizes="any" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='100'>✂️</text></svg>" />
<body class="flex flex-col h-screen w-screen bg-[#0d1116] text-white overscroll-none">
  <div class="z-10 flex overflow-auto">
    <a class="border border-transparent px-2 py-1" href="#">README</a>
  </div>
  <div class="editor w-full h-full overflow-auto border-[20px] border-[#161b22] bg-[#161b22]">
    <div class="grid font-mono text-sm">
      <pre class="[grid-column:1] [grid-row:1]"></pre>
      <textarea
        class="[grid-column:1] [grid-row:1] resize-none border-none bg-transparent text-transparent whitespace-pre caret-[orange] outline-0"
        autocomplete="off"
        autocorrect="off"
        autocapitalize="off"
        spellcheck="false"
      ></textarea>
    </div>
  </div>
</body>
<script type="module">
  import { codeToHtml } from "https://esm.sh/shiki@1.0.0"
  import cut from "./cut.js?window+prototype"
  import tests from "./cut-core-test.js"
  window.$ = (selector, root = document) => root.querySelector(selector)
  window.$$ = (selector, root = document) => [...root.querySelectorAll(selector)]
  window.sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms))
  const README = await fetch("README.md").then((res) => res.text())
  const EXEMPLE = /```js\n([\s\S]*?)```/.exec(README)[1]
  const textarea = $(".editor textarea")
  const maxSize = (textarea.clientWidth - 40) / 9
  textarea.addEventListener("input", refresh)
  addEventListener("hashchange", reload)
  $(".z-10").innerHTML += Object.keys(cut.constructors)
    .map((cname) => `<a class="border border-transparent px-2 py-1" href="#${cname}">${cname}</a>`)
    .join("\n")
  $(".z-10").innerHTML += `<div class="ml-auto px-2 py-1 font-mono flex gap-2"><span style="color:#7d0"></span><span style="color:#f34"></span></div>`
  reload()
  async function run(code) {
    try {
      code = code.replace(/^import /gm, "// import ") // ignore imports
      code = code.split(/^\/\/.*\n/m).at(-1) // take the section after the last comment
      if (code.includes("await")) return { data: await eval(`(async () => {\n${code.replace(/(.*)$/, (m) => "return " + m)}\n})()`) }
      const constant = (/const (\w+) = .*$/.exec(code) || ["", ""])[1]
      return { data: await eval(`${code}\n${constant}`) }
    } catch (error) {
      const expected = code.split("\n").at(-1).split(" //! ")[1]
      if (expected === error.message) return {}
      return { error }
    }
  }
  async function comment(line, i, all) {
    if (!line || line.startsWith("//")) return { line }
    const code = all.slice(0, i + 1).join("\n")
    const { data, error } = await run(code)
    if (line.includes("//!") && data) return { line: line.replace("//!", "//✗"), data, error }
    if (line.includes("//!")) return { line: line.replace("//!", "//✓"), data, error }
    const str = stringify(data)
    const com = line + " //> " + str.replace(/\n/g, "\\n")
    const expected = line.split("//= ")[1]
    if (expected === str) return { line: line.replace("//=", "//✓"), data, error }
    if (expected) return { line: line.replace("//=", "//✗"), data, error }
    const approx = line.split("//~ ")[1]
    if (approx && new RegExp(approx.replace(/([\\/'*+?|()[\]{}.^$-])/g, "\\$1").replace(/(\\.\\.\\.|…)/g, ".*")).test(str)) return { line: line.replace("//~", "//✓"), data, error } // prettier-ignore
    if (approx) return { line: line.replace("//~", "//✗"), data, error }
    if (data == null || line.includes("//")) return { line, data, error }
    return { line, data, error, com }
  }
  async function refresh(text) {
    if (typeof text === "string") textarea.value = text
    const info = await Promise.all(textarea.value.split("\n").map(comment))
    const error = info.findLast((v) => v.hasOwnProperty("error"))
    $(".editor").style = "outline: 1px solid rgb(255 255 255 / 5%);outline-offset: -1px;"
    if (error?.error) {
      $(".editor").style = "outline: 1px solid red;outline-offset: -1px;"
      const errorInfo = info.find((v) => v.error?.message === error.error.message)
      errorInfo.com = errorInfo.line + " //! " + errorInfo.error.message
    }
    const code = (await info.map((v) => v.com || v.line).join("\n")) + "\n"
    const html = await codeToHtml(code, { lang: "js", theme: "github-dark" })
    $(".editor pre").outerHTML = html.replace(/style="[^"]*"/, `style="grid-column:1;grid-row:1;"`).replace(/tabindex="0"/, "")
    $$(`.editor pre [style="color:#6A737D"]`).forEach((el) => (el.style = `color:${{ "!": "#f34", "=": "orange", "✓": "#7d0", "✗": "#f34", ">": "#666" }[el.textContent.trim()[2]] || "#789"}`))
    $('span[style="color:#7d0"]').textContent = code.split("//✓").length - 1
    $('span[style="color:#f34"]').textContent = (code.split("//✗").length - 1 || "") + (error?.error ? "!" : "")
  }
  function reload() {
    const colors = ["#fff", "#abc", "#fd0", "#f34", "#39f", "#fa3", "#7d0", "#f6e", "#3df"]
    const links = $$("a[href]")
    const link = links.find((el) => el.getAttribute("href") === location.hash) || links[0]
    links.forEach((el, i) => {
      if (el === link) el.style = `color:${colors[i]};border-color: ${colors[i]}1;border-bottom: 2px solid ${colors[i]};background: #FFFFFF10`
      else el.style = `color:${colors[i]}8;`
    })
    const cname = location.hash.slice(1)
    const imp = `import { ${Object.keys(cut[cname] || {}).join(", ")} } from "cut"\n\n`
    const testfn = tests
      .filter((t) => t.name && t.name.split(".")[0] === cname)
      .map((t, i) => `// ${t.name}\nconst test${i} = ${t.fn.toString()}\nawait test${i}(${t.name.split(".")[1].split(" ")[0]}) //= ${stringify(t.output)}`)
      .join("\n")
    if (testfn) return refresh(imp + testfn)
    const teststr = tests
      .filter((t) => t[0] && t[0].split(".")[0] === cname)
      .map((t, i) => `${t[0].split(".")[1]}(${t.slice(1, -1).map(stringify).join(", ")}) //= ${stringify(t.at(-1))}`)
      .join("\n")
    if (teststr) return refresh(imp + teststr)
    return refresh(EXEMPLE)
  }
  function stringify(v) {
    if (v === undefined) return "undefined"
    if (v === null) return "null"
    if (typeof v === "string") return JSON.stringify(v)
    if (typeof v === "number" || typeof v === "boolean") return String(v)
    if (v instanceof Date) {
      try {
        return `new Date("${v.toISOString()}")`
      } catch (error) {
        return `new Date("Invalid Date")`
      }
    }
    if (v instanceof RegExp) return v.toString()
    for (const constructor of [Array, Boolean, Date, Error, Function, Number, Object, RegExp, String, Symbol]) {
      if (v === constructor) return `${constructor.name}`
    }
    for (const constructor of [ArrayBuffer, Date, Error, Map, Set, WeakMap, WeakSet]) {
      if (v instanceof constructor) return `new ${constructor.name}()`
      if (v === constructor) return `${constructor.name}`
    }
    if (v instanceof Function) return v.toString()
    if (v instanceof Array) return `[${v.map(stringify).join(",")}]`
    if (v instanceof Object) return `{${Object.entries(v).map(([k, v]) => `${JSON.stringify(k)}:${stringify(v)}`).join(",")}}` // prettier-ignore
    return String(v)
  }
</script>
<!-- <script src="https://unpkg.com/@tailwindcss/browser@4"></script> -->
<style>
  /*! tailwindcss v4.0.9 | MIT License | https://tailwindcss.com */
  @layer theme, base, components, utilities;
  @layer theme {
    :root,
    :host {
      --font-sans: ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
      --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --color-white: #fff;
      --spacing: 0.25rem;
      --text-sm: 0.875rem;
      --text-sm--line-height: calc(1.25 / 0.875);
      --default-font-family: var(--font-sans);
      --default-font-feature-settings: var(--font-sans--font-feature-settings);
      --default-font-variation-settings: var(--font-sans--font-variation-settings);
      --default-mono-font-family: var(--font-mono);
      --default-mono-font-feature-settings: var(--font-mono--font-feature-settings);
      --default-mono-font-variation-settings: var(--font-mono--font-variation-settings);
    }
  }
  @layer base {
    *,
    ::after,
    ::before,
    ::backdrop,
    ::file-selector-button {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      border: 0 solid;
    }
    html,
    :host {
      line-height: 1.5;
      -webkit-text-size-adjust: 100%;
      tab-size: 4;
      font-family: var(--default-font-family, ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji");
      font-feature-settings: var(--default-font-feature-settings, normal);
      font-variation-settings: var(--default-font-variation-settings, normal);
      -webkit-tap-highlight-color: transparent;
    }
    body {
      line-height: inherit;
    }
    hr {
      height: 0;
      color: inherit;
      border-top-width: 1px;
    }
    abbr:where([title]) {
      -webkit-text-decoration: underline dotted;
      text-decoration: underline dotted;
    }
    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
      font-size: inherit;
      font-weight: inherit;
    }
    a {
      color: inherit;
      -webkit-text-decoration: inherit;
      text-decoration: inherit;
    }
    b,
    strong {
      font-weight: bolder;
    }
    code,
    kbd,
    samp,
    pre {
      font-family: var(--default-mono-font-family, ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace);
      font-feature-settings: var(--default-mono-font-feature-settings, normal);
      font-variation-settings: var(--default-mono-font-variation-settings, normal);
      font-size: 1em;
    }
    small {
      font-size: 80%;
    }
    sub,
    sup {
      font-size: 75%;
      line-height: 0;
      position: relative;
      vertical-align: baseline;
    }
    sub {
      bottom: -0.25em;
    }
    sup {
      top: -0.5em;
    }
    table {
      text-indent: 0;
      border-color: inherit;
      border-collapse: collapse;
    }
    :-moz-focusring {
      outline: auto;
    }
    progress {
      vertical-align: baseline;
    }
    summary {
      display: list-item;
    }
    ol,
    ul,
    menu {
      list-style: none;
    }
    img,
    svg,
    video,
    canvas,
    audio,
    iframe,
    embed,
    object {
      display: block;
      vertical-align: middle;
    }
    img,
    video {
      max-width: 100%;
      height: auto;
    }
    button,
    input,
    select,
    optgroup,
    textarea,
    ::file-selector-button {
      font: inherit;
      font-feature-settings: inherit;
      font-variation-settings: inherit;
      letter-spacing: inherit;
      color: inherit;
      border-radius: 0;
      background-color: transparent;
      opacity: 1;
    }
    :where(select:is([multiple], [size])) optgroup {
      font-weight: bolder;
    }
    :where(select:is([multiple], [size])) optgroup option {
      padding-inline-start: 20px;
    }
    ::file-selector-button {
      margin-inline-end: 4px;
    }
    ::placeholder {
      opacity: 1;
      color: color-mix(in oklab, currentColor 50%, transparent);
    }
    textarea {
      resize: vertical;
    }
    ::-webkit-search-decoration {
      -webkit-appearance: none;
    }
    ::-webkit-date-and-time-value {
      min-height: 1lh;
      text-align: inherit;
    }
    ::-webkit-datetime-edit {
      display: inline-flex;
    }
    ::-webkit-datetime-edit-fields-wrapper {
      padding: 0;
    }
    ::-webkit-datetime-edit,
    ::-webkit-datetime-edit-year-field,
    ::-webkit-datetime-edit-month-field,
    ::-webkit-datetime-edit-day-field,
    ::-webkit-datetime-edit-hour-field,
    ::-webkit-datetime-edit-minute-field,
    ::-webkit-datetime-edit-second-field,
    ::-webkit-datetime-edit-millisecond-field,
    ::-webkit-datetime-edit-meridiem-field {
      padding-block: 0;
    }
    :-moz-ui-invalid {
      box-shadow: none;
    }
    button,
    input:where([type="button"], [type="reset"], [type="submit"]),
    ::file-selector-button {
      appearance: button;
    }
    ::-webkit-inner-spin-button,
    ::-webkit-outer-spin-button {
      height: auto;
    }
    [hidden]:where(:not([hidden="until-found"])) {
      display: none !important;
    }
  }
  @layer utilities {
    .flex {
      display: flex;
    }
    .flex-col {
      flex-direction: column;
    }
    .h-screen {
      height: 100vh;
    }
    .w-screen {
      width: 100vw;
    }
    .bg-\[\#0d1116\] {
      background-color: #0d1116;
    }
    .text-white {
      color: var(--color-white);
    }
    .overscroll-none {
      overscroll-behavior: none;
    }
    .z-10 {
      z-index: 10;
    }
    .overflow-auto {
      overflow: auto;
    }
    .border {
      border-style: var(--tw-border-style);
      border-width: 1px;
    }
    .border-transparent {
      border-color: transparent;
    }
    .px-2 {
      padding-inline: calc(var(--spacing) * 2);
    }
    .py-1 {
      padding-block: calc(var(--spacing) * 1);
    }
    .w-full {
      width: 100%;
    }
    .h-full {
      height: 100%;
    }
    .border-\[20px\] {
      border-style: var(--tw-border-style);
      border-width: 20px;
    }
    .border-\[\#161b22\] {
      border-color: #161b22;
    }
    .bg-\[\#161b22\] {
      background-color: #161b22;
    }
    .grid {
      display: grid;
    }
    .font-mono {
      font-family: var(--font-mono);
    }
    .text-sm {
      font-size: var(--text-sm);
      line-height: var(--tw-leading, var(--text-sm--line-height));
    }
    .\[grid-column\:1\] {
      grid-column: 1;
    }
    .\[grid-row\:1\] {
      grid-row: 1;
    }
    .resize-none {
      resize: none;
    }
    .border-none {
      --tw-border-style: none;
      border-style: none;
    }
    .bg-transparent {
      background-color: transparent;
    }
    .text-transparent {
      color: transparent;
    }
    .whitespace-pre {
      white-space: pre;
    }
    .caret-\[orange\] {
      caret-color: orange;
    }
    .outline-0 {
      outline-style: var(--tw-outline-style);
      outline-width: 0px;
    }
    .ml-auto {
      margin-left: auto;
    }
    .gap-2 {
      gap: calc(var(--spacing) * 2);
    }
  }
  @property --tw-border-style {
    syntax: "*";
    inherits: false;
    initial-value: solid;
  }
  @property --tw-outline-style {
    syntax: "*";
    inherits: false;
    initial-value: solid;
  }
</style>
