<meta charset="utf-8" />
<link rel="icon" href="data:," />
<body class="m-10 flex bg-[#0d1116] text-white">
  <div class="z-10 flex w-[200px] flex-col overflow-auto -mr-px">
    <a class="border border-transparent px-2 py-1" href="#">README</a>
  </div>
  <div class="editor w-full h-full overflow-auto border-[20px] border-[#161b22] bg-[#161b22]">
    <div class="grid font-mono text-sm">
      <pre class="[grid-column:1] [grid-row:1]"></pre>
      <textarea class="[grid-column:1] [grid-row:1] resize-none border-none bg-transparent text-transparent whitespace-pre caret-[orange] outline-0" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></textarea>
    </div>
  </div>
</body>
<script type="module">
  import { codeToHtml } from "https://esm.sh/shiki@1.0.0"
  import cut from "./cut.js"
  import cutest from "./cutest.js"
  import tests from "./cut-core.test.js"
  // cut("mode", "prototype")
  //? current mode prototype breaks keys, values, but not find in window
  //? window.keys !== Object.keys

  // cut("mode", "window")
  //! keys, values, find exists in window
  //! entries, fromEntries does not exists in window

  cut("mode", "window+prototype")

  window.cut = cut
  window.cutest = cutest
  window.tests = tests
  window.$ = (selector, root = document) => root.querySelector(selector)
  window.$$ = (selector, root = document) => [...root.querySelectorAll(selector)]
  window.refresh = refresh
  const textarea = $(".editor textarea")
  const maxSize = (textarea.clientWidth - 40) / 9
  textarea.addEventListener("input", refresh)
  addEventListener("hashchange", reload)
  $(".z-10").innerHTML += Object.keys(cut.constructors)
    .flatMap((cname) =>
      Object.keys(cut[cname]).map((fname) => {
        if (fname[0] === "_") return ""
        if (cname === "Number" && Math[fname]) return ""
        return `<a class="border border-transparent px-2 py-1 ${cname}" href="#${cname}-${fname}">${cname}<span class="text-white">.${fname}</span></a>`
      })
    )
    .filter(Boolean)
    .join("\n")
  reload()
  async function run(code) {
    try {
      if (!code.includes("await")) return { data: await eval(`${code}`) }
      const lines = code.split("\n")
      const wordLineIndex = lines
        .slice()
        .reverse()
        .findIndex((l) => /^\s*[a-z]/.test(l))
      const index = wordLineIndex === -1 ? 0 : lines.length - wordLineIndex - 1
      lines[index] = "return " + lines[index]
      code = lines.join("\n")
      return { data: await eval(`(async () => {${code}})()`) }
    } catch (error) {
      return { error }
    }
  }
  async function comment(line, i, all) {
    const lines = all.slice(0, i + 1)
    if (!line) return { line }
    const { data, error } = await run(lines.join("\n"))
    if (data == null || /^(const|let|var)/.test(line)) return { line, data, error }
    const expected = line.split("//= ")[1]
    const str = data instanceof Function ? data.toString() : JSON.stringify(data)
    const com = line + " //= " + str
    if (expected === str) return { line: line.replace("//=", "//✓"), data, error }
    if (expected) return { line: line.replace("//=", "//✗"), data, error }
    return { line, data, error, com }
  }
  async function refresh(text) {
    if (typeof text === "string") textarea.value = text
    const info = await Promise.all(textarea.value.split("\n").map(comment))
    const lastInfo = info.findLast((v) => v.hasOwnProperty("error"))
    $(".editor").style = "outline: 1px solid rgb(255 255 255 / 5%);outline-offset: -1px;"
    if (lastInfo?.error) {
      $(".editor").style = "outline: 1px solid red;outline-offset: -1px;"
      const errorInfo = info.find((v) => v.error?.message === lastInfo.error.message)
      errorInfo.com = errorInfo.line + " //! " + errorInfo.error.message
    }
    const code = (await info.map((v) => v.com || v.line).join("\n")) + "\n"
    const html = await codeToHtml(code, { lang: "js", theme: "github-dark" })
    $(".editor pre").outerHTML = html.replace(/style="[^"]*"/, `style="grid-column:1;grid-row:1;"`).replace(/tabindex="0"/, "")
    $$(`.editor pre [style="color:#6A737D"]`).forEach((el) => (el.style = `color:${{ "!": "red", "=": "orange", "✓": "#7d0", "✗": "#f34" }[el.textContent.trim()[2]] || "#6A737D"}`))
  }
  function reload() {
    const links = $$("a[href]")
    const link = links.find((el) => el.getAttribute("href") === location.hash) || links[0]
    links.forEach((el) => (el.style = ""))
    link.style = "border-color: rgb(255 255 255 / 5%);border-right: 3px solid currentColor;background: #161b22"
    const [cname, fname] = location.hash.slice(1).split("-")
    const fn = cut[cname]?.[fname]
    const f = fn?.fn ?? fn
    const str = (v) => {
      if (typeof v === "function" && v.toString().includes("[native code]")) return v.name
      if (typeof v === "function") return v.toString()
      if (v instanceof Date) return `new Date(${JSON.stringify(v)})`
      return JSON.stringify(v) ?? v?.toString?.() ?? "undefined"
    }
    const teststr = tests
      .filter((t) => t[0] === `${cname}.${fname}`)
      .map((t, i) => `${fname}(${t.slice(1, -1).map(str).join(", ")})\n//= ${JSON.stringify(t.at(-1))}`)
      .join("\n\n")
    if (f) return refresh(teststr)
    return refresh(`const users = [
  { name: "John", age: 25, city: "Paris" },
  { name: "Jane", age: 30, city: "London" },
  { name: "Jack", age: 20, city: "New York" },
]
users.map("name")
users.sum("age")
users
  .group("city")
  .map("[0].name")
  .entries()
  .sum(v => 1)
  .duration()
  .format("snake")
  .is(String)
`)
  }
</script>
<!-- prettier-ignore -->
<style>
@import url(https://cdn.jsdelivr.net/npm/@unocss/reset/tailwind.min.css);
/* layer: default */
.\[grid-column\:1\]{grid-column:1;}
.\[grid-row\:1\]{grid-row:1;}
.z-10{z-index:10;}
.grid{display:grid;}
.m-10{margin:2.5rem;}
.-mr-px{margin-right:-1px;}
.h-full{height:100%;}
.w-\[200px\]{width:200px;}
.w-full{width:100%;}
.flex{display:flex;}
.flex-1{flex:1 1 0%;}
.flex-col{flex-direction:column;}
.resize-none{resize:none;}
.overflow-auto{overflow:auto;}
.overflow-hidden{overflow:hidden;}
.whitespace-pre{white-space:pre;}
.border{border-width:1px;}
.border-\[20px\]{border-width:20px;}
.border-\[\#161b22\]{--un-border-opacity:1;border-color:rgb(22 27 34 / var(--un-border-opacity));}
.border-transparent{border-color:transparent;}
.border-none{border-style:none;}
.bg-\[\#0d1116\]{--un-bg-opacity:1;background-color:rgb(13 17 22 / var(--un-bg-opacity));}
.bg-\[\#161b22\]{--un-bg-opacity:1;background-color:rgb(22 27 34 / var(--un-bg-opacity));}
.bg-transparent{background-color:transparent;}
.px-2{padding-left:0.5rem;padding-right:0.5rem;}
.py-1{padding-top:0.25rem;padding-bottom:0.25rem;}
.text-sm{font-size:0.875rem;line-height:1.25rem;}
.text-transparent{color:transparent;}
.text-white{--un-text-opacity:1;color:rgb(255 255 255 / var(--un-text-opacity));}
.font-mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
.caret-\[orange\]{caret-color:orange;}
.outline-0{outline-width:0px;}
/* Primitive colors */
.Object { color: #fd0; }
.Array { color: #f34; }
.Function { color: #39f; }
.String { color: #fa3; }
.Number { color: #7d0; }
.Date { color: #f6e; }
.RegExp { color: #3df; }
</style>
