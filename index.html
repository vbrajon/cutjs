<title>CutJS</title>
<link rel="icon" type="image/svg+xml" sizes="any" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='100'>✂️</text></svg>" />
<body class="m-10 flex bg-[#0d1116] text-white">
  <div class="z-10 flex w-[200px] flex-col overflow-auto -mr-px">
    <a class="border border-transparent px-2 py-1" href="#">README</a>
  </div>
  <div class="editor w-full h-full overflow-auto border-[20px] border-[#161b22] bg-[#161b22]">
    <div class="grid font-mono text-sm">
      <pre class="[grid-column:1] [grid-row:1]"></pre>
      <textarea
        class="[grid-column:1] [grid-row:1] resize-none border-none bg-transparent text-transparent whitespace-pre caret-[orange] outline-0"
        autocomplete="off"
        autocorrect="off"
        autocapitalize="off"
        spellcheck="false"
      ></textarea>
    </div>
  </div>
</body>
<script type="module">
  import { codeToHtml } from "https://esm.sh/shiki@1.0.0"
  import cut from "./cut.js?window+prototype"
  import tests from "./cut-core.test.js"
  // import cutest from "./cutest.js"
  // await cutest("cut-core.test.js") // TODO: make this work when ran twice
  // window.cutest = cutest
  // window.tests = tests
  // window.refresh = refresh
  window.$ = (selector, root = document) => root.querySelector(selector)
  window.$$ = (selector, root = document) => [...root.querySelectorAll(selector)]
  window.sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms))
  const README = await fetch("README.md").then((res) => res.text())
  const EXEMPLE =
    /```js([\s\S]*?)```/
      .exec(README)[1]
      .trim()
      .replace(/(.*\n){3}/, "") + "\n"
  const textarea = $(".editor textarea")
  const maxSize = (textarea.clientWidth - 40) / 9
  textarea.addEventListener("input", refresh)
  addEventListener("hashchange", reload)
  $(".z-10").innerHTML += Object.keys(cut.constructors)
    .map((cname) => `<a class="border border-transparent px-2 py-1" href="#${cname}">${cname}</a>`)
    .join("\n")
  reload()
  async function run(code) {
    try {
      if (code.includes("await")) return { data: await eval(`(async () => {\n${code.replace(/(.*)$/, (m) => "return " + m)}\n})()`) }
      const constant = (/const (\w+) = (.*)/.exec(code.split("\n").at(-1)) || ["", ""])[1]
      return { data: await eval(`${code}\n${constant}`) }
    } catch (error) {
      const expected = code.split("\n").at(-1).split(" //! ")[1]
      if (expected === error.message) return {}
      return { error }
    }
  }
  async function comment(line, i, all) {
    if (!line || line.startsWith("//")) return { line }
    const code = all.slice(0, i + 1).join("\n")
    const { data, error } = await run(code)
    if (line.includes("//!") && data) return { line: line.replace("//!", "//✗"), data, error }
    if (line.includes("//!")) return { line: line.replace("//!", "//✓"), data, error }
    const expected = line.split("//= ")[1]
    const str = data instanceof Function ? data.toString() : stringify(data)
    const com = line + " //> " + str
    if (expected === str) return { line: line.replace("//=", "//✓"), data, error }
    if (expected) return { line: line.replace("//=", "//✗"), data, error }
    if (data == null || line.includes("// ")) return { line, data, error }
    return { line, data, error, com }
  }
  async function refresh(text) {
    if (typeof text === "string") textarea.value = text
    const info = await Promise.all(textarea.value.split("\n").map(comment))
    const error = info.findLast((v) => v.hasOwnProperty("error"))
    $(".editor").style = "outline: 1px solid rgb(255 255 255 / 5%);outline-offset: -1px;"
    if (error?.error) {
      $(".editor").style = "outline: 1px solid red;outline-offset: -1px;"
      const errorInfo = info.find((v) => v.error?.message === error.error.message)
      errorInfo.com = errorInfo.line + " //! " + errorInfo.error.message
    }
    const code = (await info.map((v) => v.com || v.line).join("\n")) + "\n"
    const html = await codeToHtml(code, { lang: "js", theme: "github-dark" })
    $(".editor pre").outerHTML = html.replace(/style="[^"]*"/, `style="grid-column:1;grid-row:1;"`).replace(/tabindex="0"/, "")
    $$(`.editor pre [style="color:#6A737D"]`).forEach((el) => (el.style = `color:${{ "!": "#f34", "=": "orange", "✓": "#7d0", "✗": "#f34" }[el.textContent.trim()[2]] || "#6A737D"}`))
  }
  function reload() {
    const colors = ["#fff", "#789", "#fd0", "#f34", "#39f", "#fa3", "#7d0", "#f6e", "#3df"]
    const links = $$("a[href]")
    const link = links.find((el) => el.getAttribute("href") === location.hash) || links[0]
    links.forEach((el, i) => {
      if (el === link) el.style = `color:${colors[i]};border-color: ${colors[i]}1;border-right: 3px solid ${colors[i]};background: #FFFFFF10`
      else el.style = `color:${colors[i]}8;`
    })
    const cname = location.hash.slice(1)
    const testfn = tests
      .filter((t) => t.name && t.name.split(".")[0] === cname)
      .map((t, i) => `const fn${i} = ${t.fn.toString()}\nawait fn${i}(${t.name.split(".")[1].split(" ")[0]}) //= ${stringify(t.output)}`)
      .join("\n")
    if (testfn) return refresh(testfn)
    const teststr = tests
      .filter((t) => t[0] && t[0].split(".")[0] === cname)
      .map((t, i) => `${t[0].split(".")[1]}(${t.slice(1, -1).map(stringify).join(", ")}) //= ${stringify(t.at(-1))}`)
      .join("\n")
    if (teststr) return refresh(teststr)
    return refresh(EXEMPLE)
  }
  function stringify(v) {
    if (v === undefined) return "undefined"
    if (v === null) return "null"
    if (typeof v === "string") return JSON.stringify(v)
    if (typeof v === "number" || typeof v === "boolean") return String(v)
    if (v instanceof Date) {
      try {
        return `new Date("${v.toISOString()}")`
      } catch (error) {
        return `new Date("Invalid Date")`
      }
    }
    if (v instanceof RegExp) return v.toString()
    for (const constructor of [Array, Boolean, Date, Error, Function, Number, Object, RegExp, String, Symbol]) {
      if (v === constructor) return `${constructor.name}`
    }
    for (const constructor of [ArrayBuffer, Date, Error, Map, Set, WeakMap, WeakSet]) {
      if (v instanceof constructor) return `new ${constructor.name}()`
      if (v === constructor) return `${constructor.name}`
    }
    if (v instanceof Function) return v.toString()
    if (v instanceof Array) return `[${v.map(stringify).join(",")}]`
    if (v instanceof Object) return `{${Object.entries(v).map(([k, v]) => `${JSON.stringify(k)}:${stringify(v)}`).join(",")}}` // prettier-ignore
    return String(v)
  }
</script>
<!-- <script src="https://unpkg.com/@tailwindcss/browser@4"></script> -->
<!-- prettier-ignore -->
<style>
@import url(https://cdn.jsdelivr.net/npm/@unocss/reset/tailwind.min.css);
/* layer: default */
.\[grid-column\:1\]{grid-column:1;}
.\[grid-row\:1\]{grid-row:1;}
.z-10{z-index:10;}
.grid{display:grid;}
.m-10{margin:2.5rem;}
.-mr-px{margin-right:-1px;}
.h-full{height:100%;}
.w-\[200px\]{width:200px;}
.w-full{width:100%;}
.flex{display:flex;}
.flex-1{flex:1 1 0%;}
.flex-col{flex-direction:column;}
.resize-none{resize:none;}
.overflow-auto{overflow:auto;}
.overflow-hidden{overflow:hidden;}
.whitespace-pre{white-space:pre;}
.border{border-width:1px;}
.border-\[20px\]{border-width:20px;}
.border-\[\#161b22\]{--un-border-opacity:1;border-color:rgb(22 27 34 / var(--un-border-opacity));}
.border-transparent{border-color:transparent;}
.border-none{border-style:none;}
.bg-\[\#0d1116\]{--un-bg-opacity:1;background-color:rgb(13 17 22 / var(--un-bg-opacity));}
.bg-\[\#161b22\]{--un-bg-opacity:1;background-color:rgb(22 27 34 / var(--un-bg-opacity));}
.bg-transparent{background-color:transparent;}
.px-2{padding-left:0.5rem;padding-right:0.5rem;}
.py-1{padding-top:0.25rem;padding-bottom:0.25rem;}
.text-sm{font-size:0.875rem;line-height:1.25rem;}
.text-transparent{color:transparent;}
.text-white{--un-text-opacity:1;color:rgb(255 255 255 / var(--un-text-opacity));}
.font-mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
.caret-\[orange\]{caret-color:orange;}
.outline-0{outline-width:0px;}
</style>
